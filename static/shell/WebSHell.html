<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>shell</title>
    <!-- å¼•å…¥xterm.jsæ ¸å¿ƒåº“å’Œæ ·å¼ ä¸‹é¢ä¸‰ä¸ªæ³¨é‡Šä¸è¦åˆ ï¼ï¼ï¼-->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css"> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script> -->
    <link rel="stylesheet" href="css/xterm.min.css">
    <link rel="stylesheet" href="css/WebSHell.css">
    <script src="lib/xterm.min.js"></script>
    <!-- xterm.jsé€‚é…æ’ä»¶ï¼ˆå¯é€‰ï¼‰ -->
    <script src="lib/xterm-addon-fit.min.js"></script>
    
    <script src="/common/base.js">//src = "static\common\base.js"</script>
</head>
<body>
    <!-- ç™»å½•æ¡† -->
    <div class="login-container" id="login-container">
        <form id="loginForm" onsubmit="event.preventDefault(); connectSSH();">
            <div class="form-group">
                <label for="address">åç§°</label>
                <input type="text" id="address" placeholder="è¯·è¾“å…¥åç§°" value="æ–°çš„ç»ˆç«¯" autocomplete="off">
            </div>
            <div class="form-group">
                <label for="host">ä¸»æœºIP</label>
                <input type="text" id="host" placeholder="è¯·è¾“å…¥ä¸»æœºIP" value="172.16.37.208" autocomplete="off">
            </div>
            <div class="form-group">
                <label for="port">SSHç«¯å£</label>
                <input type="text" id="port" placeholder="è¯·è¾“å…¥ç«¯å£å·" value="22" autocomplete="off">
            </div>
            <div class="form-group">
                <label for="username">ç”¨æˆ·å</label>
                <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" value="eternity" autocomplete="off">
            </div>
            <div class="form-group">
                <label for="password">å¯†ç </label>
                <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç " autocomplete="current-password">
            </div>
            <button type="submit" class="login-button" id="connectBtn">è¿æ¥SSH</button>
        </form>
    </div>
    
    <!-- ç»ˆç«¯å®¹å™¨ -->
    <div class="terminal-wrapper" id="terminal-wrapper">
        <div id="terminal-container"></div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let terminal = null;
        let fitAddon = null;
        let ws = null;
        
        /**
         * éªŒè¯è¡¨å•å­—æ®µæ˜¯å¦å…¨éƒ¨å¡«å†™
         * @returns {boolean} - æ‰€æœ‰å­—æ®µæ˜¯å¦éƒ½å·²å¡«å†™
         */
        function  validateForm() {
            const address = document.getElementById('address').value.trim();
            const host = document.getElementById('host').value.trim();
            const port = document.getElementById('port').value.trim();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            return address && host && port && username && password;
        }
        
        /**
         * æ›´æ–°è¿æ¥æŒ‰é’®çŠ¶æ€
         * æ ¹æ®è¡¨å•éªŒè¯ç»“æœå¯ç”¨æˆ–ç¦ç”¨æŒ‰é’®
         */
        function  updateButtonState() {
            const connectBtn = document.getElementById('connectBtn');
            const isValid = validateForm();
            
            if (isValid) {
                connectBtn.disabled = false;
                connectBtn.style.opacity = '1';
                connectBtn.style.cursor = 'pointer';
            } else {
                connectBtn.disabled = true;
                connectBtn.style.opacity = '0.5';
                connectBtn.style.cursor = 'not-allowed';
            }
        }

        /**
         * é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
         */
        document.addEventListener('DOMContentLoaded', () => {
            // ä¸ºæ‰€æœ‰è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const inputs = ['address', 'host', 'port', 'username', 'password'];
            inputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', updateButtonState);
                    input.addEventListener('change', updateButtonState);
                }
            });
            
            // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
            updateButtonState();
        });

        /**
         * è¿æ¥SSHå‡½æ•°
         * å¤„ç†ç™»å½•è¡¨å•æäº¤é€»è¾‘ï¼Œå…ˆè¿æ¥åæ˜¾ç¤ºç»ˆç«¯
         */
        function  connectSSH() {
            console.log('=== connectSSH å‡½æ•°è¢«è°ƒç”¨ ===');
            // è·å–è¡¨å•æ•°æ®
            const host = document.getElementById('host').value.trim();
            const port = document.getElementById('port').value.trim();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            console.log('ç™»å½•ä¿¡æ¯:', { host, port, username });
            
            // ç®€å•éªŒè¯
            if (!host || !port || !username || !password) {
                alert('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
                console.log('è¡¨å•éªŒè¯å¤±è´¥ï¼Œç¼ºå°‘å¿…å¡«å­—æ®µ');
                return;
            }
            
            // åˆå§‹åŒ–ç»ˆç«¯
            console.log('å‡†å¤‡åˆå§‹åŒ–ç»ˆç«¯');
            initTerminal();
            
            // å…³é—­å·²æœ‰è¿æ¥
            if (ws) {
                console.log('å…³é—­å·²æœ‰è¿æ¥');
                ws.close();
            }
            console.log('=== connectSSH å‡½æ•°åˆå§‹åŒ–å®Œæˆ ===');

            try {
                // å»ºç«‹WebSocketè¿æ¥ï¼ˆæ ¹æ®å½“å‰é¡µé¢åè®®è‡ªåŠ¨é€‰æ‹© ws:// æˆ– wss://ï¼‰
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                // ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
                ws = new WebSocket(`${protocol}//${window.location.host}/shell/ws`);
                
                // è¿æ¥æˆåŠŸå›è°ƒ
                ws.onopen = () => {
                    terminal.write('\r\nğŸ”Œ æ­£åœ¨è¿æ¥ ' + host + ':' + port + '...\r\n');
                    
                    // é€šçŸ¥çˆ¶é¡µé¢ï¼šWebSocketå·²è¿æ¥
                    window.parent.postMessage({
                        type: 'websocket_connected'
                    }, '*');
                    
                    // å‘é€ç™»å½•è¯·æ±‚ï¼ˆåŒ…å«ç»ˆç«¯åˆå§‹å°ºå¯¸ï¼‰
                    ws.send(JSON.stringify({
                        type: 'login',
                        host: host,
                        port: port,
                        username: username,
                        password: password,
                        cols: terminal.cols,
                        rows: terminal.rows
                    }));
                    
                    // éšè—ç™»å½•æ¡†ï¼Œç»ˆç«¯å·²å¸¸æ˜¾
                    document.getElementById('login-container').style.display = 'none';
                    fitAddon.fit(); // é€‚é…ç»ˆç«¯å°ºå¯¸
                    
                    // ç™»å½•æˆåŠŸåï¼Œå‘çˆ¶çª—å£å‘é€ç»ˆç«¯åç§°
                    const terminalName = document.getElementById('address').value.trim();
                    if (window.parent) {
                        window.parent.postMessage({ type: 'loginSuccess', terminalName: terminalName }, '*');
                    }
                };
                
                // æ¥æ”¶åç«¯æ¶ˆæ¯
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        switch(data.type) {
                            case 'success':
                                terminal.write('\r\n' + data.msg + '\r\n');
                                // ä¿å­˜tokenåˆ°localStorage
                                if (data.token) {
                                    localStorage.setItem('terminal_token', data.token);
                                    localStorage.setItem('terminal_info', JSON.stringify({
                                        host: host,
                                        port: port,
                                        username: username,
                                        connectedAt: new Date().toISOString()
                                    }));
                                    console.log('Tokenå·²ä¿å­˜:', data.token.substring(0, 8) + '...');
                                }
                                break;
                            case 'error':
                                terminal.write('\r\nâŒ ' + data.msg + '\r\n');
                                // åç«¯è¿”å›é”™è¯¯æ—¶ï¼Œä¹Ÿæ˜¾ç¤ºç™»å½•çª—å£
                                setTimeout(() => {
                                    showLoginForm();
                                }, 3000);
                                break;
                            case 'output':
                                // è§£ç base64æ•°æ®å¹¶å†™å…¥ç»ˆç«¯
                                const buffer = atob(data.data);
                                const uint8Array = new Uint8Array(buffer.length);
                                for (let i = 0; i < buffer.length; i++) {
                                    uint8Array[i] = buffer.charCodeAt(i);
                                }
                                terminal.write(new TextDecoder('utf-8').decode(uint8Array));
                                break;
                        }
                    } catch (error) {
                        terminal.write('\r\nâŒ æ¶ˆæ¯å¤„ç†é”™è¯¯: ' + error.message + '\r\n');
                        setTimeout(() => {
                            showLoginForm();
                        }, 3000);
                    }
                };

                // è¿æ¥é”™è¯¯å›è°ƒ
                ws.onerror = (error) => {
                    terminal.write('\r\nâŒ WebSocketè¿æ¥å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯') + '\r\n');
                    // ç«‹å³æ˜¾ç¤ºç™»å½•çª—å£ï¼Œä¸å†ç­‰å¾…
                    showLoginForm();
                };

                // è¿æ¥å…³é—­å›è°ƒ
                ws.onclose = (event) => {
                    terminal.write('\r\nğŸ”Œ SSHè¿æ¥å·²å…³é—­\r\n');
                    
                    // é€šçŸ¥çˆ¶é¡µé¢ï¼šWebSocketå·²æ–­å¼€
                    window.parent.postMessage({
                        type: 'websocket_disconnected'
                    }, '*');
                    
                    // æ¸…é™¤token
                    localStorage.removeItem('terminal_token');
                    localStorage.removeItem('terminal_info');
                    console.log('Tokenå·²æ¸…é™¤');
                    // ç«‹å³æ˜¾ç¤ºç™»å½•çª—å£ï¼Œä¸å†ç­‰å¾…
                    console.log('è¿æ¥å·²å…³é—­ï¼Œå‡†å¤‡æ˜¾ç¤ºç™»å½•æ¡†');
                    // ç›´æ¥æ˜¾ç¤ºç™»å½•æ¡†ï¼Œä¸ä½¿ç”¨setTimeout
                    showLoginForm();
                    console.log('ç™»å½•æ¡†å·²æ˜¾ç¤º');
                };
            } catch (error) {
                terminal.write('\r\nâŒ è¿æ¥åˆå§‹åŒ–å¤±è´¥: ' + error.message + '\r\n');
                // ç«‹å³æ˜¾ç¤ºç™»å½•çª—å£
                showLoginForm();
            }
        }

        /**
         * æ˜¾ç¤ºç™»å½•è¡¨å•å‡½æ•°
         * å½“è¿æ¥å¤±è´¥æˆ–é€€å‡ºæ—¶è°ƒç”¨ï¼Œé‡æ–°æ˜¾ç¤ºç™»å½•çª—å£
         */
        function  showLoginForm() {
            console.log('=== showLoginForm å‡½æ•°è¢«è°ƒç”¨ ===');
            // é‡ç½®WebSocketè¿æ¥å¼•ç”¨
            if (ws) {
                console.log('é‡ç½®WebSocketè¿æ¥å¼•ç”¨');
                ws = null;
            }
            
            // æ˜¾ç¤ºç™»å½•æ¡†ï¼Œç»ˆç«¯å·²å¸¸æ˜¾
            console.log('å‡†å¤‡æ˜¾ç¤ºç™»å½•æ¡†');
            const loginContainer = document.getElementById('login-container');
            if (loginContainer) {
                loginContainer.style.display = 'block';
                console.log('ç™»å½•æ¡†å·²æ˜¾ç¤º');
            } else {
                console.error('æ‰¾ä¸åˆ°ç™»å½•æ¡†å…ƒç´ ');
            }
            
            // é‡ç½®ç»ˆç«¯ï¼ˆå¯é€‰ï¼Œæ ¹æ®éœ€è¦å†³å®šæ˜¯å¦é‡ç½®ï¼‰
            // å¦‚æœéœ€è¦å®Œå…¨é‡ç½®ç»ˆç«¯ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ç›¸å…³ä»£ç 
            console.log('=== showLoginForm å‡½æ•°æ‰§è¡Œå®Œæ¯• ===');
        }

        /**
         * åˆå§‹åŒ–ç»ˆç«¯å‡½æ•°
         * åˆ›å»ºå¹¶é…ç½®xterm.jsç»ˆç«¯
         */
        function  initTerminal() {
            if (!terminal) {
                // åˆå§‹åŒ–xterm.jsç»ˆç«¯
                terminal = new Terminal({
                    fontSize: 14,          // å­—ä½“å¤§å°
                    fontFamily: "Consolas, Monaco, monospace", // ç­‰å®½å­—ä½“ï¼ˆä»¿Windows Terminalï¼‰
                    theme: {               // é…è‰²ï¼ˆæ¥è¿‘Windows Terminalé»˜è®¤æ·±è‰²ä¸»é¢˜ï¼‰
                        background: '#000000',
                        foreground: '#ffffff',
                        cursor: '#ffffff',
                        selection: '#444444'
                    },
                    cursorBlink: true,     // å…‰æ ‡é—ªçƒ
                    scrollback: 1000,      // å›æ»šç¼“å­˜è¡Œæ•°
                    tabStopWidth: 4        // Tabé”®å®½åº¦
                });

                // åŠ è½½fitæ’ä»¶ï¼ˆè‡ªåŠ¨é€‚é…å®¹å™¨å°ºå¯¸ï¼‰
                fitAddon = new FitAddon.FitAddon();
                terminal.loadAddon(fitAddon);

                // å°†ç»ˆç«¯æŒ‚è½½åˆ°å®¹å™¨
                const container = document.getElementById('terminal-container');
                terminal.open(container);
                
                // ç›‘å¬ç»ˆç«¯è¾“å…¥ï¼ˆå°†ç”¨æˆ·è¾“å…¥å‘é€åˆ°åç«¯ï¼‰
                terminal.onData((data) => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'command',
                            data: data
                        }));
                    } else {
                        terminal.write('\r\nâŒ è¯·å…ˆè¿æ¥SSHæœåŠ¡å™¨ï¼\r\n');
                        // ç›´æ¥æ˜¾ç¤ºç™»å½•æ¡†ï¼Œä¸å†ç­‰å¾…ç”¨æˆ·è¾“å…¥
                        showLoginForm();
                    }
                });
                
                // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œè°ƒæ•´ç»ˆç«¯å°ºå¯¸
                window.addEventListener('resize', () => {
                    if (fitAddon) {
                        fitAddon.fit();
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({
                                type: 'resize',
                                cols: terminal.cols,
                                rows: terminal.rows
                            }));
                        }
                    }
                });
            }
        }

        /**
         * æ¨¡æ‹Ÿæ‰“å­—å‡½æ•°
         * @param {string} text - è¦è¾“å…¥çš„æ–‡æœ¬
         * @param {number} speed - æ‰“å­—é€Ÿåº¦ï¼ˆæ¯«ç§’/å­—ç¬¦ï¼‰ï¼Œé»˜è®¤ä¸º30ms
         * @param {boolean} enter - æ˜¯å¦è‡ªåŠ¨æŒ‰å›è½¦é”®ï¼Œé»˜è®¤ä¸ºtrue
         */
        function simulateTyping(text, speed = 30, enter = true) {
            if (!terminal) {
                console.error('ç»ˆç«¯æœªåˆå§‹åŒ–');
                return;
            }
            
            let index = 0;
            
            function  typeNextChar() {
                if (index < text.length) {
                    const char = text[index];
                    // å‘é€å­—ç¬¦åˆ°åç«¯ï¼ˆå¦‚æœå·²è¿æ¥ï¼‰
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'command',
                            data: char
                        }));
                    }
                    index++;
                    setTimeout(typeNextChar, speed);
                } else if (enter) {
                    // æ‰“å­—å®Œæˆåè‡ªåŠ¨æŒ‰å›è½¦
                    setTimeout(() => {
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({
                                type: 'command',
                                data: '\r'
                            }));
                        }
                    }, speed);
                }
            }
            
            typeNextChar();
        }

        /**
         * å‘é€ç‰¹æ®ŠæŒ‰é”®
         * @param {string} key - æŒ‰é”®åç§°
         */
        function sendSpecialKey(key) {
            if (!terminal) {
                console.error('ç»ˆç«¯æœªåˆå§‹åŒ–');
                return;
            }
            
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                console.error('WebSocketæœªè¿æ¥');
                return;
            }
            
            let keyData = '';
            switch(key) {
                case 'Enter':
                    keyData = '\r';
                    break;
                case 'Ctrl+C':
                    keyData = '\x03';
                    break;
                case 'Ctrl+D':
                    keyData = '\x04';
                    break;
                case 'Ctrl+Z':
                    keyData = '\x1a';
                    break;
                default:
                    console.warn('æœªçŸ¥æŒ‰é”®:', key);
                    return;
            }
            
            ws.send(JSON.stringify({
                type: 'command',
                data: keyData
            }));
        }

        /**
         * ç›‘å¬æ¥è‡ªçˆ¶çª—å£çš„æ¶ˆæ¯
         * æ¥æ”¶æ‰“å­—æŒ‡ä»¤å¹¶æ‰§è¡Œ
         */
        window.addEventListener('message', (event) => {
            // å®‰å…¨æ£€æŸ¥ï¼šå¯ä»¥æ·»åŠ æ¥æºéªŒè¯
            // if (event.origin !== 'your-expected-origin') return;
            
            if (event.data) {
                switch(event.data.type) {
                    case 'typeCommand':
                        const text = event.data.text;
                        const speed = event.data.speed || 30;
                        const enter = event.data.enter !== false; // é»˜è®¤ä¸ºtrue
                        simulateTyping(text, speed, enter);
                        break;
                    case 'sendKey':
                        sendSpecialKey(event.data.key);
                        break;
                }
            }
        });
    </script>
</body>
</html>
